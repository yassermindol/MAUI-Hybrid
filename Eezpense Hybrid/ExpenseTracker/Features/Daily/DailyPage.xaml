<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="ExpenseTracker.Features.Daily.DailyPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:converters="clr-namespace:ExpenseTracker.Converters"
    xmlns:local="clr-namespace:ExpenseTracker.Features.Daily"
    xmlns:templates="clr-namespace:ExpenseTracker.Features.Templates"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    Title="Daily Summary Report">
    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:InvertBooleanConverter x:Key="InvertBooleanConverter" />
        </ResourceDictionary>
        <DataTemplate x:Key="SumOfDayTemplate">
            <ViewCell>
                <Grid
                    BackgroundColor="{AppThemeBinding Light=LightSteelBlue,
                                                      Dark=MidnightBlue}"
                    RowSpacing="0"
                    VerticalOptions="Fill">
                    <Grid.RowDefinitions>
                        <RowDefinition />
                        <RowDefinition />
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>
                    <Label
                        Grid.Row="0"
                        Grid.Column="0"
                        Margin="10,7,0,3"
                        FontAttributes="Bold"
                        LineBreakMode="WordWrap"
                        VerticalTextAlignment="End">
                        <Label.FormattedText>
                            <FormattedString>
                                <Span FontAttributes="Bold" Text="{Binding Date}" />
                            </FormattedString>
                        </Label.FormattedText>
                    </Label>
                    <Label
                        Grid.Row="0"
                        Grid.Column="1"
                        Margin="0,0,10,0"
                        HorizontalTextAlignment="End"
                        VerticalTextAlignment="End">
                        <Label.FormattedText>
                            <FormattedString>
                                <Span FontAttributes="Bold" Text="{Binding CurrencySymbol}" />
                                <Span Text=" " />
                                <Span FontAttributes="Bold" Text="{Binding TotalStr}" />
                            </FormattedString>
                        </Label.FormattedText>
                    </Label>
                    <BoxView
                        Grid.Row="1"
                        Grid.ColumnSpan="2"
                        Margin="8,0,10,8"
                        BackgroundColor="{Binding BarColor}"
                        CornerRadius="5"
                        HeightRequest="15"
                        HorizontalOptions="Start"
                        VerticalOptions="Start"
                        WidthRequest="{Binding BarWidth}" />
                </Grid>
            </ViewCell>
        </DataTemplate>
        <DataTemplate x:Key="ExpenseListItemTemplateV2">
            <ViewCell>
                <templates:ExpenseListItemTemplateV2 />
            </ViewCell>
        </DataTemplate>
        <!--  Register your template selector as a resource  -->
        <local:DailyTemplateSelector
            x:Key="DailyTemplateSelector"
            ChildTemplate="{StaticResource ExpenseListItemTemplateV2}"
            ParentTemplate="{StaticResource SumOfDayTemplate}" />
    </ContentPage.Resources>

    <StackLayout>
        <Label
            Margin="10"
            FontSize="16"
            IsVisible="{Binding IsTotalVisible}">
            <Label.FormattedText>
                <FormattedString>
                    <Span FontAttributes="Bold" Text="Total: " />
                    <Span FontAttributes="Bold" Text="{Binding CurrencySymbol}" />
                    <Span Text=" " />
                    <Span FontAttributes="Bold" Text="{Binding Total}" />
                </FormattedString>
            </Label.FormattedText>
        </Label>
        <StackLayout IsVisible="{Binding IsBusy}" VerticalOptions="CenterAndExpand">
            <ActivityIndicator IsRunning="True" IsVisible="{Binding IsBusy}" />
            <Label
                Margin="0,5,0,0"
                HorizontalOptions="Center"
                Text="Loading..."
                VerticalOptions="Start" />
        </StackLayout>

        <Label
            HorizontalOptions="Center"
            IsVisible="{Binding IsNoRecordsToShowVisible}"
            Text="No records to show."
            VerticalOptions="CenterAndExpand" />

        <ListView
            x:Name="listview"
            CachingStrategy="RetainElement"
            HasUnevenRows="True"
            IsVisible="{Binding IsListVisible}"
            ItemTemplate="{StaticResource DailyTemplateSelector}"
            ItemsSource="{Binding DailyItems}"
            SelectedItem="{Binding UiExpenseSelectedItem, Mode=TwoWay}"
            SeparatorColor="Blue"
            VerticalOptions="StartAndExpand">
            <ListView.Behaviors>
                <toolkit:EventToCommandBehavior Command="{Binding UiExpenseSelectedCommand}" EventName="ItemSelected" />
            </ListView.Behaviors>
        </ListView>

        <Button
            Margin="20,10,20,10"
            Command="{Binding SelectDateRangeCommand}"
            CornerRadius="10"
            HeightRequest="45"
            IsEnabled="{Binding IsBusy, Converter={StaticResource InvertBooleanConverter}}"
            Text="{Binding SelectDateButtonText}"
            VerticalOptions="End" />
    </StackLayout>
</ContentPage>